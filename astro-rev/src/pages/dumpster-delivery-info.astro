---
import Layout from '../layouts/MainLayout.astro';
import { companyInfo } from '@/data/company-details';
const phone = companyInfo.phone;

const keywords = ["dumpster rental", "dumpster delivery", "book dumpster", "schedule dumpster", "Spartanburg", "Greenville"];
---

<Layout title="Dumpster Delivery Information | Joe The Guy" keywords={keywords}>
  <div class="w-full min-h-screen bg-gray-50 py-8">
    <div class="max-w-6xl mx-auto px-4 md:px-8">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-raleway font-bold text-center mb-2">Complete Your Booking</h1>
        <p class="text-center text-gray-600 text-sm md:text-base">Please provide your delivery information to finalize your dumpster rental</p>
      </div>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Order Summary -->
        <div class="lg:w-1/3">
          <div class="bg-white rounded-xl shadow-md p-6 sticky top-8">
            <h2 class="text-xl md:text-2xl font-raleway font-bold mb-4 pb-2 border-b-2 border-primary">Order Summary</h2>

            <div id="order-summary" class="space-y-4">
              <!-- Will be populated by JavaScript -->
            </div>

            <div class="mt-6 pt-4 border-t-2 border-gray-200">
              <div class="flex justify-between items-center">
                <span class="text-lg font-semibold">Total:</span>
                <span id="order-total" class="text-2xl font-bold text-primary">$0</span>
              </div>
              <p class="text-xs text-gray-500 mt-2">Price is per week</p>
            </div>
          </div>
        </div>

        <!-- Delivery Information Form -->
        <div class="lg:w-2/3">
          <div class="bg-white rounded-xl shadow-md p-6 md:p-8">
            <h2 class="text-xl md:text-2xl font-raleway font-bold mb-6">Delivery Information</h2>

            <form id="delivery-form" class="space-y-6">
              <!-- Name Fields -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="firstName" class="block text-sm font-semibold text-gray-700 mb-2">First Name *</label>
                  <input
                    type="text"
                    id="firstName"
                    name="firstName"
                    required
                    class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Joseph"
                  />
                </div>
                <div>
                  <label for="lastName" class="block text-sm font-semibold text-gray-700 mb-2">Last Name *</label>
                  <input
                    type="text"
                    id="lastName"
                    name="lastName"
                    required
                    class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Guy"
                  />
                </div>
              </div>

              <!-- Email -->
              <div>
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="john.doe@example.com"
                />
              </div>

              <!-- Phone -->
              <div>
                <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">Phone Number *</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="(864) 555-1234"
                />
              </div>

              <!-- Address -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Delivery Address *</label>

                <!-- Street Address -->
                <input
                  type="text"
                  id="street"
                  name="street"
                  required
                  class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent mb-3"
                  placeholder="Street Address"
                />

                <!-- City, State, Zip Row -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <input
                    type="text"
                    id="city"
                    name="city"
                    required
                    class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="City"
                  />
                  <input
                    type="text"
                    id="state"
                    name="state"
                    required
                    maxlength="2"
                    class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent uppercase"
                    placeholder="State"
                  />
                  <input
                    type="text"
                    id="zipCode"
                    name="zipCode"
                    required
                    pattern="[0-9]{5}"
                    maxlength="5"
                    class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Zip Code"
                  />
                </div>
              </div>

              <!-- Delivery Notes -->
              <div>
                <label for="deliveryNotes" class="block text-sm font-semibold text-gray-700 mb-2">Delivery Notes</label>
                <textarea
                  id="deliveryNotes"
                  name="deliveryNotes"
                  rows="4"
                  class="w-full border border-gray-300 rounded-lg p-3 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                  placeholder="Any special instructions for delivery? (e.g., gate code, preferred placement location)"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">Optional - Let us know if there are any special instructions for delivery</p>
              </div>

              <!-- Submit Button -->
              <div class="pt-4">
                <button
                  type="submit"
                  class="w-full bg-primary hover:bg-accent1 text-white font-semibold py-3 md:py-4 px-6 rounded-xl text-base md:text-lg transition-colors"
                >
                  Submit Booking Request
                </button>
                <p class="text-xs text-gray-500 mt-3 text-center">By submitting, you agree to our terms of service. We'll contact you shortly to confirm your booking.</p>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-8 relative animate-scale-in">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
          <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-raleway font-bold text-gray-900 mb-3">Booking Submitted!</h3>
        <p class="text-gray-600 mb-6">Thank you for your booking! We'll contact you shortly to confirm your dumpster rental.</p>
        <button id="success-modal-close" class="w-full bg-primary hover:bg-accent1 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
          Got It
        </button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-8 relative animate-scale-in">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
          <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-raleway font-bold text-gray-900 mb-3">Submission Failed</h3>
        <p id="error-modal-message" class="text-gray-600 mb-6">There was an error submitting your booking. Please try again or call us directly at {phone}</p>
        <button id="error-modal-close" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <style>
    @keyframes scale-in {
      0% {
        transform: scale(0.9);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .animate-scale-in {
      animation: scale-in 0.2s ease-out;
    }
  </style>

  <script define:vars={{ phone }}>
    if (typeof window !== "undefined") {
      window.addEventListener("DOMContentLoaded", () => {
        // Modal utility functions
        const showSuccessModal = () => {
          const modal = document.getElementById("success-modal");
          modal?.classList.remove("hidden");
        };

        const showErrorModal = (message?: string) => {
          const modal = document.getElementById("error-modal");
          const messageEl = document.getElementById("error-modal-message");
          if (message && messageEl) {
            messageEl.textContent = message;
          }
          modal?.classList.remove("hidden");
        };

        const hideModal = (modalId: string) => {
          const modal = document.getElementById(modalId);
          modal?.classList.add("hidden");
        };

        // Modal close button handlers
        document.getElementById("success-modal-close")?.addEventListener("click", () => {
          hideModal("success-modal");
          // Clear the order data
          sessionStorage.removeItem("dumpsterOrder");
          sessionStorage.removeItem("completeBooking");
          // Redirect to home
          window.location.href = "/";
        });

        document.getElementById("error-modal-close")?.addEventListener("click", () => {
          hideModal("error-modal");
        });

        // Close modals on backdrop click
        document.getElementById("success-modal")?.addEventListener("click", (e) => {
          if (e.target === document.getElementById("success-modal")) {
            hideModal("success-modal");
          }
        });

        document.getElementById("error-modal")?.addEventListener("click", (e) => {
          if (e.target === document.getElementById("error-modal")) {
            hideModal("error-modal");
          }
        });

        // Close modals on escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            hideModal("success-modal");
            hideModal("error-modal");
          }
        });

        // Check if order data exists
        const orderData = sessionStorage.getItem("dumpsterOrder");

        if (!orderData) {
          // Redirect to dumpsters page if no order data
          showErrorModal("Please select a dumpster and dates first.");
          setTimeout(() => {
            window.location.href = "/dumpsters";
          }, 2000);
          return;
        }

        // Parse order data
        const order = JSON.parse(orderData);

        // Populate order summary
        const summaryDiv = document.getElementById("order-summary");
        const totalSpan = document.getElementById("order-total");

        if (summaryDiv && totalSpan) {
          summaryDiv.innerHTML = `
            <div>
              <p class="text-sm text-gray-600">Dumpster Size</p>
              <p class="text-lg font-semibold">${order.type} Cubic Yard</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Delivery Date</p>
              <p class="text-base font-semibold">${order.deliveryDate}</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Pickup Date</p>
              <p class="text-base font-semibold">${order.pickupDate}</p>
            </div>
          `;

          totalSpan.textContent = `$${order.price}`;
        }

        // Handle form submission
        const form = document.getElementById("delivery-form");
        const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;

        form?.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Disable submit button and show loading state
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = "Sending...";
          }

          const formData = {
            firstName: (document.getElementById("firstName") as HTMLInputElement).value,
            lastName: (document.getElementById("lastName") as HTMLInputElement).value,
            email: (document.getElementById("email") as HTMLInputElement).value,
            phone: (document.getElementById("phone") as HTMLInputElement).value,
            street: (document.getElementById("street") as HTMLInputElement).value,
            city: (document.getElementById("city") as HTMLInputElement).value,
            state: (document.getElementById("state") as HTMLInputElement).value,
            zipCode: (document.getElementById("zipCode") as HTMLInputElement).value,
            deliveryNotes: (document.getElementById("deliveryNotes") as HTMLTextAreaElement).value,
            order: order
          };

          try {
            // Send booking data to API endpoint
            const response = await fetch("/api/send-booking", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error || "Failed to send booking");
            }

            console.log("Booking submitted successfully:", result);

            // Store complete booking data for confirmation
            sessionStorage.setItem("completeBooking", JSON.stringify(formData));

            // Show success modal
            showSuccessModal();

          } catch (error) {
            console.error("Error submitting booking:", error);

            // Show error modal
            showErrorModal(`There was an error submitting your booking. Please try again or call us directly at ${phone}`);

            // Re-enable submit button
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = "Submit Booking Request";
            }
          }
        });
      });
    }
  </script>
</Layout>
