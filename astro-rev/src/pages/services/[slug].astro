---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import MainLayout from '@/layouts/MainLayout.astro';

export async function getStaticPaths() {
  const services = await getCollection("services");
  return services.map((service) => ({
    params: { slug: service.slug },
    props: { service },
  }));
}

const { service } = Astro.props;
---

<MainLayout title={`${service.data.title} | Joe The Guy`}>

  <!-- Service Header -->
  <div class="w-full h-auto font-raleway bg-secondary-light items-center py-8">
    <h1 class="px-4 md:px-8 pt-8 pb-4 text-2xl md:text-3xl uppercase text-black text-center font-semibold">{service.data.title}</h1>
    <div class="mx-auto w-24 h-[1.5px] bg-primary mb-8"><!-- Horizontal line --></div>

    <!-- Description -->
    {service.data.description && (
      <div class="mx-4 md:mx-12 lg:mx-32 xl:mx-60 text-center text-base md:text-lg text-black mb-8">
        <p>{service.data.description}</p>
      </div>
    )}
  </div>

  <!-- Rotating Gallery -->
  {service.data.gallery && service.data.gallery.length > 0 && (
    <div class="w-full h-auto bg-white py-8 md:py-12">
      <h2 class="px-4 md:px-8 pb-4 text-2xl md:text-3xl uppercase text-black text-center font-semibold">Gallery</h2>
      <div class="mx-auto w-24 h-[1.5px] bg-primary mb-8"><!-- Horizontal line --></div>

      <div class="relative mx-auto max-w-2xl px-4">
        <!-- Gallery Container -->
        <div class="relative w-full overflow-hidden rounded-lg shadow-lg" style="aspect-ratio: 3/4;">
          {service.data.gallery.map((img, index) => (
            <div
              class={`gallery-slide absolute inset-0 transition-opacity duration-700 ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
              data-index={index}
            >
              <Image
                src={img}
                alt={`${service.data.title} photo ${index + 1}`}
                class="w-full h-full object-cover"
              />
            </div>
          ))}
        </div>

        <!-- Navigation Arrows -->
        <button
          class="gallery-prev absolute left-2 md:left-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/75 text-white p-2 md:p-3 rounded-full transition-colors duration-300 z-10"
          aria-label="Previous image"
        >
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        <button
          class="gallery-next absolute right-2 md:right-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/75 text-white p-2 md:p-3 rounded-full transition-colors duration-300 z-10"
          aria-label="Next image"
        >
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <!-- Dots Indicator -->
        <div class="flex justify-center gap-2 mt-4">
          {service.data.gallery.map((_, index) => (
            <button
              class={`gallery-dot w-2 h-2 md:w-3 md:h-3 rounded-full transition-colors duration-300 ${index === 0 ? 'bg-primary' : 'bg-gray-300'}`}
              data-index={index}
              aria-label={`Go to image ${index + 1}`}
            >
            </button>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Back to Services Button -->
  <div class="w-full h-auto bg-secondary-light py-8 md:py-12">
    <div class="flex justify-center align-middle">
      <a href="/services" class="bg-primary uppercase text-white font-semibold text-sm px-8 py-2 rounded-2xl hover:bg-accent1 hover:text-white transition-colors duration-300">Back to Services</a>
    </div>
  </div>

</MainLayout>

<script>
  // Gallery functionality
  let currentIndex = 0;
  let autoRotateInterval: number;
  const ROTATION_INTERVAL = 5000; // 5 seconds

  function initGallery() {
    const slides = document.querySelectorAll('.gallery-slide');
    const dots = document.querySelectorAll('.gallery-dot');
    const prevBtn = document.querySelector('.gallery-prev');
    const nextBtn = document.querySelector('.gallery-next');

    if (slides.length === 0) return;

    function showSlide(index: number) {
      // Hide all slides
      slides.forEach(slide => {
        (slide as HTMLElement).classList.remove('opacity-100');
        (slide as HTMLElement).classList.add('opacity-0');
      });

      // Show current slide
      (slides[index] as HTMLElement).classList.remove('opacity-0');
      (slides[index] as HTMLElement).classList.add('opacity-100');

      // Update dots
      dots.forEach((dot, i) => {
        if (i === index) {
          dot.classList.remove('bg-gray-300');
          dot.classList.add('bg-primary');
        } else {
          dot.classList.remove('bg-primary');
          dot.classList.add('bg-gray-300');
        }
      });

      currentIndex = index;
    }

    function nextSlide() {
      const nextIndex = (currentIndex + 1) % slides.length;
      showSlide(nextIndex);
    }

    function prevSlide() {
      const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
      showSlide(prevIndex);
    }

    function resetAutoRotate() {
      clearInterval(autoRotateInterval);
      autoRotateInterval = window.setInterval(nextSlide, ROTATION_INTERVAL);
    }

    // Navigation buttons
    prevBtn?.addEventListener('click', () => {
      prevSlide();
      resetAutoRotate();
    });

    nextBtn?.addEventListener('click', () => {
      nextSlide();
      resetAutoRotate();
    });

    // Dot navigation
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showSlide(index);
        resetAutoRotate();
      });
    });

    // Start auto-rotation
    autoRotateInterval = window.setInterval(nextSlide, ROTATION_INTERVAL);

    // Pause on hover
    const galleryContainer = document.querySelector('.gallery-slide')?.parentElement;
    galleryContainer?.addEventListener('mouseenter', () => {
      clearInterval(autoRotateInterval);
    });

    galleryContainer?.addEventListener('mouseleave', () => {
      resetAutoRotate();
    });
  }

  // Initialize on page load
  initGallery();

  // Reinitialize on view transitions (if using Astro view transitions)
  document.addEventListener('astro:page-load', initGallery);
</script>
